[Home](https://plackyhacker.github.io)

# ESXi, Workstation, and Fusion have Uninitialized memory usage, leading to an information leak

## Introduction

At the time of writing I am currently studying for me [OSEE](https://www.offsec.com/courses/exp-401/) exam. Alongside the course material I am looking at past CVEs to see if I can exploit them myself. As I learn effectively by 'teaching' I have decided to post my attempts here.

## CVE-2017-4905

This CVE affected **VMware ESXi** 6.5 without patch ESXi650-201703410-SG, 6.0 U3 without patch ESXi600-201703401-SG, 6.0 U2 without patch ESXi600-201703403-SG, 6.0 U1 without patch ESXi600-201703402-SG, 5.5 without patch ESXi550-201703401-SG; **Workstation Pro / Player 12.x** prior to 12.5.5; and **Fusion Pro / Fusion** 8.x prior to 8.5.6 have uninitialized memory usage.

The CVE relies upon the backdoor functionality in VMWare and was presented in the AWE course. However, I wanted to implement the backdoor protocol myself, differrent to how it was implemented in the course. I wanted to code the backdoor protocol (at least the elements that trigger the bug) entirely in `asm`.

The [VMWare (now Broadcom)](https://support.broadcom.com/web/ecx/support-content-notification/-/external/content/SecurityAdvisories/0/23517) security advisory states "VMware would like to thank ZDI and Team Sniper from Tencent Security for reporting this issue to us". So the best place to start is trying to find a PoC or details of the bug.

Tencent published [A bunch of red pills VMWare escapes](https://keenlab.tencent.com/en/2018/04/23/A-bunch-of-Red-Pills-VMware-Escapes/) which contains the following statement:

"A buffer will be allocated on the stack when processing the backdoor requests. This buffer should be initialized in the BDOORHB callback. But when requesting invalid commands, the callback fails to properly clear the buffer, causing the uninitialized content of the stack buffer to be leaked to the guest. With this bug we can effectively defeat the ASLR of vmware-vmx running on the host."

So, our task is to exploit this CVE to disclose the base address of `vmware-vmx`.

### So What?

If you are completely new to binary exploitation you may be asking "who cares if we can disclose data on the stack?", the key part is to **effectively defeat ASLR**. Address Space Layout Randomization is a mitigation to prevent the exploitation of memory corruption vulnerabilities by randomising the location in memory where modules are loaded. In short this bug can be exploited alongside other bugs to gain code execution in VMWare as it reveales the location of where executable code is in the `vmware-vmx` module.

## The Backdoor Protocol

To write a backdoor protocol you need to include `asm` in your Visual Studio project, becasue that is how it works. I will explain that next. If you do not understand how to write `asm` in your project check out my post on [Exploring x64 Calling Conventions](https://plackyhacker.github.io/shellcodez/x64-calling-conventions).


[Home](https://plackyhacker.github.io)
